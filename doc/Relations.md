# Relations

رابطه بین موجودیت‌ها در دو قسمت از کدها باید ذکر شود. اول موقع تعریف موجودیت (کلاس) به عنوان فیلد از نوع Pluf_DB_Field_Foreignkey یا  Pluf_DB_Field_Manytomany که اولی برای رابطه یک به یک یا یک به چند و دومی برای رابطه چند به چند استفاده می‌شود. قطعه کد زیر قسمتی از تعریف فیلدها و ارتباط موجودیت User_Account را نشان می‌دهد:

```php
function init()
    {
        $this->_a['table'] = 'user_accounts';
        $this->_a['cols'] = array(
            'id' => array(
                'type' => 'Pluf_DB_Field_Sequence',
                'is_null' => true,
                'editable' => false,
                'readable' => true
            ),
            'login' => array(
                'type' => 'Pluf_DB_Field_Varchar',
                'is_null' => false,
                'unique' => true,
                'size' => 50,
                'editable' => false,
                'readable' => true
            ),
            
            // ...
            
            /*
             * Foreign keys 
             */
            'avatar_id' => array(
                'type' => 'Pluf_DB_Field_Foreignkey',
                'model' => 'User_Avatar',
                'relate_name' => 'account',
                'name' => 'avatar',
                'is_null' => true,
                'editable' => false
            ),
            /*
             * Relations
             */
            'groups' => array(
                'type' => 'Pluf_DB_Field_Manytomany',
                'blank' => true,
                'model' => 'User_Group',
                'name' => 'category',
                'relate_name' => 'accounts',
                'editable' => false,
                'readable' => false
            ),
            'roles' => array(
                'type' => 'Pluf_DB_Field_Manytomany',
                'blank' => true,
                'relate_name' => 'accounts',
                'editable' => false,
                'readable' => false,
                'model' => 'User_Role'
            )
        );
    }
}
```

علاوه بر این باید در یک فایل به نام relations.php نیز روابط بین موجودیت‌ها توصیف شود. این فایل باید در پوشه اصلی ماژول (در کنار فایل‌هایی مثل urls.php و module.json) قرار داده شود. در زیر نمونه‌ای از محتوای فایل relations.php آورده شده است. برای روابط یک به یک یا یک به چند از relate_to و برای روابط چند به چند از relate_to_many استفاده می‌شود.

‍‍‍‍‍‍‍```php
<?php
return array (
    'User_Account' => array(
        'relate_to_many' => array(
            'User_Group',
            'User_Role'
        ),
    ),
    'User_Message' => array(
        'relate_to' => array(
            'User_Account'
        )
    )
);
```
نکته اینکه برای روابط چند به چند رابطه فقط باید در یک طرف تعریف شود وگرنه موقع نصب حلقه بینهایت تشکیل می‌شود. به عنوان مثال در نمونه بالا User_Account با User_Group و User_Role ارتباط چند با چند دارد. هر دو این روابط در کلاس User_Account تعریف شده‌اند. بنابراین دیگر نباید در کلاس‌های User_Group و User_Role این ارتباط دوباره تعریف شود. 

نکته دیگر اینکه در فایل relations.php روابط باید به همان ترتیبی تعریف شوند که در کلاس ها تعریف شده‌اند. به عنوان مثال چون ارتباط چند به چند بین User_Account و User_Group در کلاس User_Account تعریف شده است بنابراین در فایل relations.php نیز این رابطه در قسمت مربوط به User_Account آورده شده است. 

## Notes on Define Relations

هنگام تعریف ارتباط بین موجودیت‌ها به عنوان فیلد (در تابع init() کلاس‌ها) خصوصیات زیر برای فیلد مربوط به رابطه قابل تعریف است. بسته به نوع فیلد هر یک از این خصوصیات کاربردی خاص دارند که در ادامه شرح داده می‌شود. 

- name
- relate_name
- graphql_name
- graphql_field

در ادامه نام فیلد که در واقع به عنوان کلید در آرایه -a['cols'] تعریف می‌شود را با field_name نشان می‌دهیم. توجه شود که این مورد یک خصوصیت از فیلد نیست بلکه کلید به کار رفته برای تعریف آن فیلد است که به عنوان نام فیلد هم استفاده می‌شود. برای روابط یک به چند، این کلید به عنوان نام ستون در جدولی که برای آن کلاس در پایگاه داده ایجاد می‌شود مورد استفاده قرار می‌گیرد.  

به طور کلی وقتی فیلدی به عنوان یک رابطه یک به چند (نوع Pluf_DB_Field_Foreignkey) یا چند به چند (نوع Pluf_DB_Field_Manytomany) تعریف می‌شود به صورت خودکار یک سری تابع در کلاس مربوطه ایجاد می‌شود که می‌توان در هر جایی از این توابع استفاده کرد. خصوصیاتی که در بالا ذکر شد بسته به نوع فیلد در نام این توابع تاثیر دارند.

### One-to-Many Relations 

به ازای هر رابطه یک به چند (از نوع Pluf_DB_Field_Foreignkey) یک تابع در کلاس مربوطه و یک تابع در کلاس مقابل (که طرف دوم رابطه است) ایجاد می‌شود. نام این توابع به صورت زیر است:

‍‍‍```
get_[name|feild_name]()
```
این تابع آبجکتی را برمی‌گرداند که با آبجکت فراخوانی شده ارتباط دارد (نوع این آبجکت همان نوعی است که در خصوصیت model در تعریف رابطه ذکر می‌شود).

در کلاس مقابل این رابطه، تابعی ایجاد می‌شود که نام آن به صورت زیر است:

```
get_[relate_name|type_name]_list()
```

این تابع لیستی از آبجکت‌ها که با آبجکت فراخوانی شده ارتباط دارند را برمی‌گرداند. منظور از type_name در عبارت بالا نام مدل یا همان کلاس به صورت lowercase است.

#### نمونه

به عنوان مثال، در نمونه بالا کلاس User_Account با کلاس User_Avatar رابطه یک به چند دارد و شناسه آواتار مورد استفاده به عنوان کلید خارجی در کلاس User_Account قرار داده شده است. با توجه به تعریف بالا موارد زیر ایجاد خواهند شد:

- در پایگاه داده، در جدول مربوط به User_Account که نام آن user_accounts است ستونی با عنوان avatar_id تعریف می‌شود.
- در کلاس User_Account تابعی با نام get_avatar() تعریف می‌شود که خروجی آن کلاسی از نوع User_Avatar است. توجه شود که اگر خصوصیت name برای فیلد avatar_id تعریف نشده بود نام این تابع get_avatar_id() بود که باز هم خروجی آن از نوع User_Avatar بود.
- در کلاس User_Avatar نیز که طرف دوم رابطه است تابعی به نام get_account_list() تعریف می‌شود که خروجی آن یک آرایه از User_Account هاست. توجه شود که اگر خصوصیت relate_name برای فیلد avatar_id تعریف نشده بود نام این تابع get_user_account_list() بود که خروجی آن باز هم آرایه‌ای از User_Account ها بود.  


### Many-to-Many Relations

به ازای هر رابطه چند به چند (از نوع Pluf_DB_Field_Manytomany) یک تابع در کلاس مربوطه و یک تابع در کلاس مقابل (که طرف دوم رابطه است) ایجاد می‌شود. نام این توابع به صورت زیر است:

‍‍‍```
get_[name|feild_name]_list()
```
این تابع لیستی از آبجکت‌ها را برمی‌گرداند که با آبجکت فراخوانی شده ارتباط دارند (نوع این آبجکت‌ها همان نوعی است که در خصوصیت model در تعریف رابطه ذکر می‌شود).

در کلاس مقابل این رابطه، تابعی ایجاد می‌شود که نام آن به صورت زیر است:

```
get_[relate_name|type_name]_list()
```

این تابع لیستی از آبجکت‌ها که با آبجکت فراخوانی شده ارتباط دارند را برمی‌گرداند. منظور از type_name در عبارت بالا نام مدل یا همان کلاس به صورت lowercase است.

#### نمونه

به عنوان مثال، در نمونه بالا کلاس User_Account با کلاس User_Group رابطه چند به چند دارد و این رابطه با کلیدی به نام groups در کلاس User_Account تعریف شده است. با توجه به تعریف بالا موارد زیر ایجاد خواهند شد:

- در پایگاه داده، برای هر رابطه چند به چند یک جدول ایجاد می‌شود که نام این جدول به صورت user_account_user_group_assoc است. این جدول دو ستون user_account_id و user_group_id دارد.
- در کلاس User_Account تابعی با نام get_category_list() تعریف می‌شود که خروجی آن کلاسی آرایه‌ای از User_Group ها است. توجه شود که اگر خصوصیت name برای رابطه‌ی groups تعریف نشده بود نام این تابع get_groups_list() بود که باز هم خروجی آن آرایه‌ای از User_Group ها بود.
- در کلاس User_Group نیز که طرف دوم رابطه است تابعی به نام get_accounts_list() تعریف می‌شود که خروجی آن یک آرایه از User_Account هاست. توجه شود که اگر خصوصیت relate_name برای رابطه groups تعریف نشده بود نام این تابع get_user_account_list() بود که خروجی آن باز هم آرایه‌ای از User_Account ها بود.  


### graphql support

از نسخه 4.0.0 از کوئری‌های graphql برای تعیین ساختار پاسخ نهایی پشتیبانی می‌شود.
به این منظور دو خصوصیت graphql_name و graphql_feild در تعریف فیلدهای مختلف از جمله فیلدهای مربوط به رابطه‌ها در نظر گرفته شده است.

#### graphql_feild

با این خصوصیت می‌توان دسترسی به یک فیلد از کلاس را از طریق graphql تعیین کرد. اگر این مقدار false باشد امکان دسترسی به این فیلد از طریق کوئری‌های graphql وجود ندارد. مقدار پیش‌فرض برای این خصوصیت true است.

#### graphql_name

در درخواست‌هایی که کوئری‌های graphql استفاده می‌شود از خصوصیت graphql_name به عنوان نام فیلد در کوئری graphql برای این فیلد از کلاس مورد استفاده قرار می‌گیرد. در  

